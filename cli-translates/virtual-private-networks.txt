LAB Virtual Private Networks (VPN)

# setting up our evnvironment

gcloud auth login

export PROJECT_ID=qwiklabs-gcp-00-a7b70e590738

export US_REGION=us-central1
export EU_REGION=europe-west1

gcloud config set project $PROJECT_ID

Task 1: Explore the networks and instances

# viewing the networks 

gcloud compute networks list 

# listing subenets

gcloud compute networks subnets list --network=vpn-network-1

gcloud compute networks subnets list --network=vpn-network-2

# viewing firewall rules

gcloud compute firewall-rules list 

# retrieving the instances IP addresses

gcloud compute instances list

# Storing the Ips in an environment variable

export SER_1_INT_IP=10.5.4.2
export SER_1_EXT_IP=35.232.232.241
export SER_2_INT_IP=10.1.3.2
export SER_2_EXT_IP=34.77.63.116

# ssh into server1

gcloud compute ssh server-1 --zone=us-central1-b

# testing connectivity between server-1 and server-2

ping -c 3 $SER_2_EXT_IP
ping -c 3 $SER_2_INT_IP

exit ssh

# testing connectivity between server-2 and server-1

gcloud compute ssh server-2 --zone=europe-west1-b

ping -c 3 $SER_1_EXT_IP
ping -c 3 $SER_1_INT_IP

Task 2: Create the VPN gateways and tunnels

# Reserving static IP address for each VPN gateway.

gcloud compute addresses create vpn-1-static-ip \
--region=$US_REGION 

gcloud compute addresses create vpn-2-static-ip \
--region=$EU_REGION

export VPN1_IP=34.71.76.113
export VPN2_IP=35.187.92.148

# Creating the vpn-1 gateway and tunnel1to2

gcloud compute target-vpn-gateways create vpn-1 \
--network vpn-network-1 \
--region us-central1

# Creating three forwarding rules that instruct Google Cloud to send ESP (IPsec), UDP 500, and UDP 4500 traffic to the gateway.

gcloud compute forwarding-rules create vpn-1-rule-esp \
--ip-protocol=ESP \
--address=$VPN1_IP \
--target-vpn-gateway=vpn-1 \
--region=us-central1

gcloud compute forwarding-rules create vpn-1-rule-udp500 \
--ip-protocol=UDP \
--ports=500 \
--address=$VPN1_IP \
--target-vpn-gateway=vpn-1 \
--region=us-central1

gcloud compute forwarding-rules create vpn-1-rule-udp4500 \
--ip-protocol=UDP \
--ports=4500 \
--address=$VPN1_IP \
--target-vpn-gateway=vpn-1 \
--region=us-central1

# creating the tunnel1to2. this is a static route based tunnel, so we have to manually create each route.

gcloud compute vpn-tunnels create tunnel1to2 \
--region=us-central1 \
--peer-address=$VPN2_IP \
--shared-secret=gcprocks \
--ike-version=2 \
--local-traffic-selector=0.0.0.0/0 \
--target-vpn-gateway=vpn-1

# creating a cloud route to handle traffic forwading

gcloud compute routes create tunnel1to2-route-1 \
--network=vpn-network-1 \
--next-hop-vpn-tunnel=tunnel1to2 \
--next-hop-vpn-tunnel-region=us-central1 \
--destination-range=10.1.3.0/24

# Create the vpn-2 gateway and tunnel2to1

gcloud compute target-vpn-gateways create vpn-2 \
--network=vpn-network-2 \
--region=europe-west1

# Creating three forwarding rules that instruct Google Cloud to send ESP (IPsec), UDP 500, and UDP 4500 traffic to the gateway.

gcloud compute forwarding-rules create vpn-2-rule-esp \
--ip-protocol=ESP \
--address=$VPN2_IP \
--target-vpn-gateway=vpn-2 \
--region=europe-west1

gcloud compute forwarding-rules create vpn-2-rule-udp500 \
--ip-protocol=UDP \
--ports=500 \
--address=$VPN2_IP \
--target-vpn-gateway=vpn-2 \
--region=europe-west1

gcloud compute forwarding-rules create vpn-2-rule-udp4500 \
--ip-protocol=UDP \
--ports=4500 \
--address=$VPN2_IP \
--target-vpn-gateway=vpn-2 \
--region=europe-west1

# creating the tunnel2to1. this is a static route based tunnel, so we have to manually create each route.

gcloud compute vpn-tunnels create tunnel2to1 \
--region=europe-west1 \
--peer-address=$VPN1_IP \
--shared-secret=gcprocks \
--ike-version=2 \
--local-traffic-selector=0.0.0.0/0 \
--target-vpn-gateway=vpn-2

# creating a cloud route to handle traffic forwading

gcloud compute routes create tunnel2to1-route-2 \
--network=vpn-network-2 \
--next-hop-vpn-tunnel=tunnel2to1 \
--next-hop-vpn-tunnel-region=europe-west1 \
--destination-range=10.5.4.0/24

Task 3: Verify VPN connectivity

gcloud compute ssh server-1 --zone=us-central1-b

export SER_2_INT_IP=10.1.3.2
export SER_2_EXT_IP=34.77.63.116

# testing connectivity between server-1 and server-2

ping -c 3 $SER_2_EXT_IP
ping -c 3 $SER_2_INT_IP

exit ssh

# testing connectivity between server-2 and server-1

gcloud compute ssh server-2 --zone=europe-west1-b

export SER_1_INT_IP=10.5.4.2
export SER_1_EXT_IP=35.184.83.152

ping -c 3 $SER_1_EXT_IP
ping -c 3 $SER_1_INT_IP

---------------------END OF LAB-------------